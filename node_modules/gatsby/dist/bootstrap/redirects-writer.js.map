{"version":3,"sources":["../../src/bootstrap/redirects-writer.js"],"names":["lastHash","writeRedirects","bootstrapFinished","program","redirects","store","getState","browserRedirects","Array","from","values","filter","r","redirectInBrowser","newHash","crypto","createHash","update","JSON","stringify","digest","fs","writeFile","directory","exports","debouncedWriteRedirects","_","debounce","emitter","on"],"mappings":";;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA,IAAIA,QAAQ,GAAG,IAAf;;AAEA,MAAMC,cAAc,GAAG,YAAY;AACjCC,EAAAA,iBAAiB,GAAG,IAApB;;AAEA,MAAI;AAAEC,IAAAA,OAAF;AAAWC,IAAAA;AAAX,MAAyBC,aAAMC,QAAN,EAA7B,CAHiC,CAKjC;;;AACA,QAAMC,gBAAgB,GAAGC,KAAK,CAACC,IAAN,CAAWL,SAAS,CAACM,MAAV,EAAX,EAA+BC,MAA/B,CACvBC,CAAC,IAAIA,CAAC,CAACC,iBADgB,CAAzB;;AAIA,QAAMC,OAAO,GAAGC,gBACbC,UADa,CACD,KADC,EAEbC,MAFa,CAENC,IAAI,CAACC,SAAL,CAAeZ,gBAAf,CAFM,EAGba,MAHa,CAGL,KAHK,CAAhB;;AAKA,MAAIN,OAAO,KAAKd,QAAhB,EAA0B;AACxB;AACD;;AAEDA,EAAAA,QAAQ,GAAGc,OAAX;AAEA,QAAMO,iBAAGC,SAAH,CACJ,+BAASnB,OAAO,CAACoB,SAAjB,EAA6B,uBAA7B,CADI,EAEJL,IAAI,CAACC,SAAL,CAAeZ,gBAAf,EAAiC,IAAjC,EAAuC,CAAvC,CAFI,CAAN;AAID,CAzBD;;AA2BAiB,OAAO,CAACvB,cAAR,GAAyBA,cAAzB;AAEA,IAAIC,iBAAiB,GAAG,KAAxB;;AACA,MAAMuB,uBAAuB,GAAGC,gBAAEC,QAAF,CAAW,MAAM;AAC/C;AACA,MAAIzB,iBAAJ,EAAuB;AACrBD,IAAAA,cAAc;AACf;AACF,CAL+B,EAK7B,GAL6B,CAAhC;;AAOA2B,eAAQC,EAAR,CAAY,iBAAZ,EAA8B,MAAM;AAClCJ,EAAAA,uBAAuB;AACxB,CAFD","sourcesContent":["import _ from \"lodash\"\nimport crypto from \"crypto\"\nimport fs from \"fs-extra\"\nimport { store, emitter } from \"../redux/\"\nimport { joinPath } from \"gatsby-core-utils\"\n\nlet lastHash = null\n\nconst writeRedirects = async () => {\n  bootstrapFinished = true\n\n  let { program, redirects } = store.getState()\n\n  // Filter for redirects that are meant for the browser.\n  const browserRedirects = Array.from(redirects.values()).filter(\n    r => r.redirectInBrowser\n  )\n\n  const newHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(browserRedirects))\n    .digest(`hex`)\n\n  if (newHash === lastHash) {\n    return\n  }\n\n  lastHash = newHash\n\n  await fs.writeFile(\n    joinPath(program.directory, `.cache/redirects.json`),\n    JSON.stringify(browserRedirects, null, 2)\n  )\n}\n\nexports.writeRedirects = writeRedirects\n\nlet bootstrapFinished = false\nconst debouncedWriteRedirects = _.debounce(() => {\n  // Don't write redirects again until bootstrap has finished.\n  if (bootstrapFinished) {\n    writeRedirects()\n  }\n}, 250)\n\nemitter.on(`CREATE_REDIRECT`, () => {\n  debouncedWriteRedirects()\n})\n"],"file":"redirects-writer.js"}